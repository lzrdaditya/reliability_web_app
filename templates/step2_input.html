<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Step 2: Enter Data</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f5f7fa; }
        .main-card { max-width:900px; margin:36px auto; }
        th, td { text-align: center; vertical-align: middle; }
        table input, table select { width: 100%; }
        .row-highlight { background: #e7f4ea !important; }
    </style>
</head>
<body>
<div class="card main-card shadow">
    <div class="card-header bg-success text-white">
        <h4 class="mb-0">
            {% if method == "failure" %}
                Step 2: Enter Times to Failure Data
            {% else %}
                Step 2: Enter State and Time to F or S
            {% endif %}
        </h4>
    </div>
    <div class="card-body">
        {% if error %}
            <div class="alert alert-danger mb-3">{{ error }}</div>
        {% endif %}
        <form method="post" id="dataForm">
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle" id="dataTable">
                    <thead class="table-light">
                        <tr>
                            <th>D-IS</th>
                            {% if method == "failure" %}
                                <th>Time Failed<br><span class="text-secondary">(hours, cycles...)</span></th>
                            {% else %}
                                <th>State<br><span class="text-secondary">F or S</span></th>
                                <th>Time to F or S<br><span class="text-secondary">(hours, cycles...)</span></th>
                            {% endif %}
                            <th>Subset ID</th>
                        </tr>
                    </thead>
                    <tbody>
    {% for i in range(1,26) %}
        {% set p_state = '' %}
        {% set p_time = '' %}
        {% if pre_filled_data and i <= pre_filled_data|length %}
            {% set p_state = pre_filled_data[i-1].state %}
            {% set p_time = pre_filled_data[i-1].time %}
        {% endif %}
        <tr>
            <td>{{i}}</td>
            {% if method == "failure" %}
                <td>
                    <input name="time_failed_{{i}}" type="number" min="0" class="form-control form-control-sm data-cell" placeholder="Time" value="{{ p_time }}">
                </td>
            {% else %}
                <td>
                    <select name="state_{{i}}" class="form-select form-select-sm data-cell" onchange="updateRowHighlight(this)">
                        <option value=""></option>
                        <option value="F" {% if p_state == 'F' %}selected{% endif %}>F (Failed)</option>
                        <option value="S" {% if p_state == 'S' %}selected{% endif %}>S (Suspended)</option>
                    </select>
                </td>
                <td>
                    <input name="time_{{i}}" type="number" min="0" class="form-control form-control-sm data-cell" placeholder="Time" value="{{ p_time }}">
                </td>
            {% endif %}
            <td>
                <input name="subset_id_{{i}}" type="text" class="form-control form-control-sm data-cell" placeholder="Optional">
            </td>
        </tr>
    {% endfor %}
</tbody>
                </table>
            </div>
            <div class="text-end mt-3">
                <button type="submit" class="btn btn-success">Next &rarr;</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Highlight row if State is S (Suspended)
    function updateRowHighlight(selectElem) {
        var row = selectElem.closest('tr');
        if(selectElem.value === "S") {
            row.classList.add('row-highlight');
        } else {
            row.classList.remove('row-highlight');
        }
    }

    // Auto highlight on load if any S state prefilled (for edit mode)
    window.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('select[name^="state_"]').forEach(function(sel) {
            updateRowHighlight(sel);
        });
    });

    // Simple validation: highlight empty required fields before submission
    document.getElementById('dataForm').addEventListener('submit', function(e) {
        let valid = true;
        let method = "{{ method }}";
        let rows = document.querySelectorAll('#dataTable tbody tr');
        rows.forEach(function(row, idx) {
            if (method === "failure") {
                let timeCell = row.querySelector('input[name^="time_failed_"]');
                if (timeCell && timeCell.value && isNaN(timeCell.value)) {
                    timeCell.classList.add('is-invalid');
                    valid = false;
                } else {
                    timeCell.classList.remove('is-invalid');
                }
            } else {
                let stateCell = row.querySelector('select[name^="state_"]');
                let timeCell = row.querySelector('input[name^="time_"]');
                if ((stateCell.value === "F" || stateCell.value === "S") && !timeCell.value) {
                    timeCell.classList.add('is-invalid');
                    valid = false;
                } else {
                    timeCell.classList.remove('is-invalid');
                }
            }
        });
        if (!valid) {
            e.preventDefault();
            alert("Please fill all required numeric fields with valid values.");
        }
    });
</script>
</body>
</html>